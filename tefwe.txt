—è –¥–µ–ª–∞—é –±–æ—Ç –∫–æ—Ç–æ—Ä—ã–π —Å–æ–±–∏—Ä–∞–µ—Ç —Å–æ–æ–±—â–µ–∏–Ω—è –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –∏ –ø—Ä–∏—Å—ã–ª–∞–µ—Ç –∏—Ö —Ç–æ–º—É –∫—Ç–æ –Ω–∞–∂–∞–ª —Å—Ç–∞—Ä—Ç –ø–æ—Ç–æ–º –æ–±–Ω–æ–≤–ª—è–µ—Ç –Ω–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω–æ–µ 

# main.py
import asyncio
import logging
from aiogram import Bot, Dispatcher
from handlers import start, inline, reply
from dotenv import load_dotenv
import os

load_dotenv()
token_bot = os.environ.get("BOT_TOKEN")

logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

if not token_bot:
    logger.critical("–¢–æ–∫–µ–Ω –±–æ—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω!")
    exit(1)

bot = Bot(token=token_bot)
dp = Dispatcher()

# –°–ª–æ–≤–∞—Ä—å –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–¥–∞—á –ø–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º
user_tasks = {}

async def main():
    logger.info("–ó–∞–ø—É—Å–∫ –±–æ—Ç–∞...")
    dp.include_routers(start.router, inline.router, reply.router)
    logger.info("–†–æ—É—Ç–µ—Ä—ã –ø–æ–¥–∫–ª—é—á–µ–Ω—ã.")

    try:
        logger.info("–ë–æ—Ç –Ω–∞—á–∞–ª –æ–ø—Ä–æ—Å (polling)...")
        await dp.start_polling(bot)
    except (KeyboardInterrupt, SystemExit):
        logger.info("–ë–æ—Ç –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º.")
    finally:
        # –û—Ç–º–µ–Ω—è–µ–º –≤—Å–µ —Ñ–æ–Ω–æ–≤—ã–µ –∑–∞–¥–∞—á–∏ –ø—Ä–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏
        for task in user_tasks.values():
            if not task.done():
                task.cancel()
        logger.info("–ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Ä–∞–±–æ—Ç—ã –±–æ—Ç–∞.")
        await bot.session.close()

if __name__ == "__main__":
    logger.info("–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∑–∞–ø—É—â–µ–Ω–æ.")
    try:
        asyncio.run(main())
    except KeyboardInterrupt:
        logger.info("–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º (Ctrl+C).")

# handlers/start.py
from aiogram import Router
from aiogram.types import Message
from aiogram.filters import Command
from database import get_new_direct_trades, mark_trade_as_sent
from database.db import async_session
from keyboards import main_reply_keyboard, item_inline_keyboard
from main import user_tasks
import asyncio
import logging
from datetime import datetime

router = Router()

def format_trade_message(trade_data: dict) -> str:
    """–§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –æ —Å–¥–µ–ª–∫–µ"""
    msg_parts = ["üì¢ <b>–ù–û–í–ê–Ø –ü–†–Ø–ú–ê–Ø –°–î–ï–õ–ö–ê !!!!!!------!!!!!!</b>\n"]
    
    msg_parts.append(f"\nüîó –°—Å—ã–ª–∫–∞: {trade_data['url']}\n")
    
    if trade_data.get('message_number'):
        msg_parts.append(f"#‚É£ –ù–æ–º–µ—Ä —Å–æ–æ–±—â–µ–Ω–∏—è: {trade_data['message_number']}")
    
    if trade_data.get('publication_date'):
        if isinstance(trade_data['publication_date'], datetime):
            pub_date = trade_data['publication_date'].strftime('%d.%m.%Y')
        else:
            pub_date = str(trade_data['publication_date'])
        msg_parts.append(f"üìÖ –î–∞—Ç–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏: {pub_date}")
    
    if trade_data.get('debtor_name'):
        msg_parts.append(f"üë§ –î–æ–ª–∂–Ω–∏–∫: {trade_data['debtor_name']}")
    
    if trade_data.get('debtor_inn'):
        msg_parts.append(f"üî¢ –ò–ù–ù –¥–æ–ª–∂–Ω–∏–∫–∞: {trade_data['debtor_inn']}")
    
    if trade_data.get('auction_type'):
        msg_parts.append(f"‚öñÔ∏è –í–∏–¥ —Ç–æ—Ä–≥–æ–≤: {trade_data['auction_type']}")
    
    if trade_data.get('place_of_conduct'):
        msg_parts.append(f"üìç –ú–µ—Å—Ç–æ –ø—Ä–æ–≤–µ–¥–µ–Ω–∏—è: {trade_data['place_of_conduct']}")
    
    if trade_data.get('start_applications'):
        if isinstance(trade_data['start_applications'], datetime):
            start_apps = trade_data['start_applications'].strftime('%d.%m.%Y %H:%M')
        else:
            start_apps = str(trade_data['start_applications'])
        msg_parts.append(f"‚è≥ –ù–∞—á–∞–ª–æ –∑–∞—è–≤–æ–∫: {start_apps}")
    
    if trade_data.get('end_applications'):
        if isinstance(trade_data['end_applications'], datetime):
            end_apps = trade_data['end_applications'].strftime('%d.%m.%Y %H:%M')
        else:
            end_apps = str(trade_data['end_applications'])
        msg_parts.append(f"‚åõ –ö–æ–Ω–µ—Ü –∑–∞—è–≤–æ–∫: {end_apps}")
    
    if trade_data.get('arbitrator_name'):
        msg_parts.append(f"üßë‚Äç‚öñÔ∏è –ê—Ä–±–∏—Ç—Ä: {trade_data['arbitrator_name']}")
    
    if trade_data.get('arbitrator_inn'):
        msg_parts.append(f"üî¢ –ò–ù–ù –∞—Ä–±–∏—Ç—Ä–∞: {trade_data['arbitrator_inn']}")
    
    if trade_data.get('emails'):
        msg_parts.append(f"üìß Email: {trade_data['emails']}")
    
    if trade_data.get('lots'):
        msg_parts.append("\nüì¶ <b>–õ–û–¢–´:</b>\n")
        for lot in trade_data['lots']:
            desc = lot['description'] or '–ë–µ–∑ –æ–ø–∏—Å–∞–Ω–∏—è'
            price_value = lot['price']
            if price_value is not None:
                try:
                    price = f"{float(price_value):,.0f}".replace(",", " ")
                except (ValueError, TypeError):
                    price = "N/A"
            else:
                price = "0"
            lot_number = lot['lot_number'] if lot['lot_number'] is not None else 0
            msg_parts.append(f"{lot_number}. {desc} ‚Äî <b>{price} —Ä—É–±.</b>")
    
    return "\n".join(msg_parts)

async def send_trades_to_user(bot, user_id):
    """–§–æ–Ω–æ–≤–∞—è –∑–∞–¥–∞—á–∞ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–¥–µ–ª–æ–∫ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é"""
    iteration_count = 0
    while True:
        iteration_count += 1
        try:
            logging.info(f"[–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id}] –ò—Ç–µ—Ä–∞—Ü–∏—è #{iteration_count}: –ü—Ä–æ–≤–µ—Ä—è—é –Ω–æ–≤—ã–µ —Å–¥–µ–ª–∫–∏...")
            
            async with async_session() as session:
                trades = await get_new_direct_trades(limit=5)
                logging.info(f"[–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id}] –ü–æ–ª—É—á–µ–Ω–æ {len(trades)} —Å–¥–µ–ª–æ–∫")
                
                if not trades:
                    logging.info(f"[–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id}] –ù–æ–≤—ã—Ö —Å–¥–µ–ª–æ–∫ –Ω–µ—Ç")
                else:
                    for trade in trades:
                        try:
                            msg_text = format_trade_message(trade)
                            sent_message = await bot.send_message(
                                chat_id=user_id, 
                                text=msg_text, 
                                parse_mode="HTML", 
                                reply_markup=item_inline_keyboard(trade['id'])
                            )
                            logging.info(f"[–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id}] –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ —Å–¥–µ–ª–∫–∞ {trade['id']} (message_id: {sent_message.message_id})")
                            
                            # –ü–æ–º–µ—á–∞–µ–º –∫–∞–∫ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω–æ–µ
                            success = await mark_trade_as_sent(trade['id'])
                            if success:
                                logging.info(f"[–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id}] –°–¥–µ–ª–∫–∞ {trade['id']} –ø–æ–º–µ—á–µ–Ω–∞ –∫–∞–∫ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω–∞—è")
                            else:
                                logging.warning(f"[–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id}] –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–º–µ—Ç–∏—Ç—å —Å–¥–µ–ª–∫—É {trade['id']} –∫–∞–∫ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—É—é")
                            
                        except Exception as send_error:
                            logging.error(f"[–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id}] –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–¥–µ–ª–∫–∏ {trade['id']}: {send_error}", exc_info=True)
                        
        except Exception as e:
            logging.error(f"[–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id}] –û—à–∏–±–∫–∞ –≤ –∏—Ç–µ—Ä–∞—Ü–∏–∏ #{iteration_count}: {e}", exc_info=True)
        
        await asyncio.sleep(20)

@router.message(Command("start"))
async def start_handler(message: Message, bot):
    user_id = message.from_user.id
    logging.info(f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id} ({message.from_user.username}) –æ—Ç–ø—Ä–∞–≤–∏–ª –∫–æ–º–∞–Ω–¥—É /start")
    
    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
    await message.answer("–ü—Ä–∏–≤–µ—Ç! –ù–∞—á–∏–Ω–∞—é –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –¥–∞–Ω–Ω—ã–µ –æ –ø—Ä—è–º—ã—Ö —Å–¥–µ–ª–∫–∞—Ö...", reply_markup=main_reply_keyboard())
    
    # –ï—Å–ª–∏ —É–∂–µ –µ—Å—Ç—å –∑–∞–¥–∞—á–∞ –¥–ª—è —ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è - –æ—Ç–º–µ–Ω—è–µ–º
    if user_id in user_tasks:
        if not user_tasks[user_id].done():
            user_tasks[user_id].cancel()
        del user_tasks[user_id]
        logging.info(f"–ü—Ä–µ–¥—ã–¥—É—â–∞—è –∑–∞–¥–∞—á–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id} –æ—Ç–º–µ–Ω–µ–Ω–∞")
    
    # –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é —Ñ–æ–Ω–æ–≤—É—é –∑–∞–¥–∞—á—É –¥–ª—è —ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    task = asyncio.create_task(send_trades_to_user(bot, user_id))
    user_tasks[user_id] = task
    logging.info(f"–ó–∞–ø—É—â–µ–Ω–∞ —Ñ–æ–Ω–æ–≤–∞—è –∑–∞–¥–∞—á–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id}")

# database/dao.py
from sqlalchemy import select, func
from sqlalchemy.orm import selectinload
from typing import List, Dict, Any, Optional
from sqlalchemy.exc import SQLAlchemyError
import logging
from .base import connection
from .models import User, DirectTrades, ArbitrationManager, ArbitrationManagerContact, Lot

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–≥–∏—Ä–æ–≤–∞–Ω–∏—è
Logger = logging.getLogger(__name__)


@connection
async def set_user( tg_id: int, username: str, full_name: str) -> Optional[User]: # <-- session —É–¥–∞–ª–µ–Ω
    
    try:
        # –õ–æ–≥–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ –¥–ª—è –ª—É—á—à–µ–π –æ—Ç–ª–∞–¥–∫–∏
        Logger.debug(f"–ü–æ–∏—Å–∫/—Å–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å ID {tg_id}")
        user = await session.scalar(select(User).filter_by(id=tg_id))

        if not user:
            new_user = User(id=tg_id, username=username, full_name=full_name)
            session.add(new_user)
            await session.commit()
            Logger.info(f"–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–ª –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å ID {tg_id}!")
            return new_user
        else:
            Logger.info(f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å ID {tg_id} –Ω–∞–π–¥–µ–Ω!")
            return user
    except SQLAlchemyError as e:
        Logger.error(f"–û—à–∏–±–∫–∞ SQLAlchemy –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {tg_id}: {e}")
        await session.rollback()
        return None
    except Exception as e: # –î–æ–±–∞–≤–ª–µ–Ω–∞ –æ–±—â–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∏—Å–∫–ª—é—á–µ–Ω–∏–π
        Logger.error(f"–ù–µ–æ–∂–∏–¥–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {tg_id}: {e}", exc_info=True)
        await session.rollback() # –ù–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π, —Ö–æ—Ç—è rollback –¥–ª—è select –Ω–µ –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω
        return None

# @connection
async def get_new_direct_trades(limit: int = 10) -> List[Dict[str, Any]]:
    """
    –ü–æ–ª—É—á–∞–µ—Ç –Ω–æ–≤—ã–µ –ø—Ä—è–º—ã–µ —Å–¥–µ–ª–∫–∏ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ —Ç–µ–ª–µ–≥—Ä–∞–º.
    Session –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è —è–≤–Ω–æ, —Ç–∞–∫ –∫–∞–∫ –¥–µ–∫–æ—Ä–∞—Ç–æ—Ä @connection –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è.
    """
    try:
        Logger.debug(f"–ù–∞—á–∏–Ω–∞—é –ø–æ–ª—É—á–∞—Ç—å —Å–¥–µ–ª–∫–∏, limit={limit}")
        # –í—ã–±–∏—Ä–∞–µ–º —Ç–æ–ª—å–∫–æ –Ω–µ—Ä–∞–∑–æ—Å–ª–∞–Ω–Ω—ã–µ –ø—Ä—è–º—ã–µ —Å–¥–µ–ª–∫–∏ —Å –ø–æ–ª–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π
        stmt = select(DirectTrades)\
            .options(
                selectinload(DirectTrades.arbitrator).selectinload(ArbitrationManager.contacts),
                selectinload(DirectTrades.lots)
            )\
            .where(DirectTrades.type_ == True, DirectTrades.is_sent == False)\
            .order_by(DirectTrades.publication_date.desc())\
            .limit(limit)
        
        result = await session.execute(stmt)
        trades = result.scalars().all()
        Logger.debug(f"–ò–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—É—á–µ–Ω–æ {len(trades)} —Å–¥–µ–ª–æ–∫")
        
        # –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤ —Å–ª–æ–≤–∞—Ä–∏ –¥–ª—è —É–¥–æ–±–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏
        trades_data = []
        for trade in trades:
            Logger.debug(f"–û–±—Ä–∞–±–∞—Ç—ã–≤–∞—é —Å–¥–µ–ª–∫—É ID {trade.id}")
            # –°–æ–±–∏—Ä–∞–µ–º email'—ã –∞—Ä–±–∏—Ç—Ä–∞–∂–Ω–æ–≥–æ —É–ø—Ä–∞–≤–ª—è—é—â–µ–≥–æ
            emails = []
            if trade.arbitrator and trade.arbitrator.contacts:
                emails = [contact.email for contact in trade.arbitrator.contacts if contact.email]
            
            # –°–æ–±–∏—Ä–∞–µ–º –ª–æ—Ç—ã
            lots_data = []
            if trade.lots:
                for lot in trade.lots:
                    lots_data.append({
                        'lot_number': lot.lot_number,
                        'description': lot.description or '',
                        'price': float(lot.price) if lot.price else 0.0
                    })
            
            trade_data = {
                'id': trade.id,
                'message_number': trade.message_number,
                'publication_date': trade.publication_date,
                'url': trade.url,
                'debtor_name': trade.debtor_name,
                'debtor_inn': trade.debtor_inn,
                'auction_type': trade.auction_type,
                'place_of_conduct': trade.place_of_conduct,
                'debtor_phone': trade.debtor_phone,
                'start_applications': trade.start_applications,
                'end_applications': trade.end_applications,
                'arbitrator_name': trade.arbitrator.full_name if trade.arbitrator else None,
                'arbitrator_inn': trade.arbitrator.inn if trade.arbitrator else None,
                'emails': ', '.join(emails) if emails else None,
                'lots': lots_data
            }
            trades_data.append(trade_data)
            Logger.debug(f"–°–¥–µ–ª–∫–∞ ID {trade.id} –æ–±—Ä–∞–±–æ—Ç–∞–Ω–∞")
        
        Logger.info(f"–ü–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω–æ {len(trades_data)} —Å–¥–µ–ª–æ–∫ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏")
        return trades_data
    except SQLAlchemyError as e:
        Logger.error(f"–û—à–∏–±–∫–∞ SQLAlchemy –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –Ω–æ–≤—ã—Ö –ø—Ä—è–º—ã—Ö —Å–¥–µ–ª–æ–∫: {e}")
        return []
    except Exception as e:
        Logger.error(f"–ù–µ–æ–∂–∏–¥–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –ø—Ä—è–º—ã—Ö —Å–¥–µ–ª–æ–∫: {e}", exc_info=True) # –î–æ–±–∞–≤–ª–µ–Ω–æ exc_info
        return []

@connection
async def mark_trade_as_sent(trade_id: int) -> bool:
    """
    –ü–æ–º–µ—á–∞–µ—Ç —Å–¥–µ–ª–∫—É –∫–∞–∫ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—É—é.
    Session –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è –¥–µ–∫–æ—Ä–∞—Ç–æ—Ä–æ–º @connection.
    """
    try:
        Logger.debug(f"–ü–æ–º–µ—Ç–∫–∞ —Å–¥–µ–ª–∫–∏ {trade_id} –∫–∞–∫ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω–æ–π")
        # –ò—Å–ø–æ–ª—å–∑—É–µ–º –±–æ–ª–µ–µ –ø—Ä–æ—Å—Ç–æ–π –∑–∞–ø—Ä–æ—Å
        stmt = select(DirectTrades).where(
            DirectTrades.id == trade_id, 
            DirectTrades.is_sent == False
        )
        result = await session.execute(stmt)
        trade = result.scalar_one_or_none()
        
        if trade:
            Logger.debug(f"–°–¥–µ–ª–∫–∞ {trade_id} –Ω–∞–π–¥–µ–Ω–∞, –æ–±–Ω–æ–≤–ª—è—é —Å—Ç–∞—Ç—É—Å")
            trade.is_sent = True
            await session.commit()
            Logger.info(f"–°–¥–µ–ª–∫–∞ {trade_id} –ø–æ–º–µ—á–µ–Ω–∞ –∫–∞–∫ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω–∞—è")
            return True
        else:
            # –ü—Ä–æ–≤–µ—Ä–∏–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ —Å–¥–µ–ª–∫–∞ –≤–æ–æ–±—â–µ
            stmt_check = select(DirectTrades.id).where(DirectTrades.id == trade_id)
            result_check = await session.execute(stmt_check)
            exists = result_check.scalar_one_or_none()
            
            if exists:
                Logger.warning(f"–°–¥–µ–ª–∫–∞ {trade_id} —É–∂–µ –±—ã–ª–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ (is_sent=True)")
            else:
                Logger.warning(f"–°–¥–µ–ª–∫–∞ {trade_id} –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö")
            return False
    except SQLAlchemyError as e:
        Logger.error(f"–û—à–∏–±–∫–∞ SQLAlchemy –ø—Ä–∏ –ø–æ–º–µ—Ç–∫–µ —Å–¥–µ–ª–∫–∏ {trade_id} –∫–∞–∫ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω–æ–π: {e}")
        await session.rollback()
        return False
    except Exception as e:
        Logger.error(f"–ù–µ–æ–∂–∏–¥–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–º–µ—Ç–∫–µ —Å–¥–µ–ª–∫–∏ {trade_id} –∫–∞–∫ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω–æ–π: {e}", exc_info=True)
        await session.rollback()
        return False